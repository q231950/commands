def changedFrameworks = ''

node {
    stage("Clone") {
        checkout scm
    }

    stage("Build") {
        sh 'swift build'
        sh 'swift package generate-xcodeproj'

        sh "xcodebuild build-for-testing -scheme 'Commands-Package' -configuration 'Debug' -derivedDataPath './derived_data'"
    }

    stage("Find Test Targets") {
        // find the file paths of the files which have changed. Compare the whole set of changes from this branch compared to the target branch
        filePaths = sh(returnStdout: true, script: "git diff origin/${ env.CHANGE_TARGET } --no-commit-id --name-only").trim()
        echo filePaths
        
        try {
            // Create the list of changed frameworks by throwing the file paths into the resolver
            changedFrameworks = sh(returnStdout: true, script: "./test-target-resolver.swift ${ filePaths }").trim()
            echo changedFrameworks
        } catch (error) {
            echo "This should not be an error: ${ error }"
        } finally {
        }
    }

    stage("Test") {
        try {
            sh "xcodebuild test-without-building -scheme 'Commands-Package' -configuration 'Debug' -derivedDataPath './derived_data' ${ changedFrameworks }"
        } catch (error) {
            echo 'test-without-building did not return with status 0'
            echo "${error}"
        } finally {
            echo 'Run Trainer'
            sh '/usr/local/bin/bundler install --path vendor/bundle'
            sh '/usr/local/bin/bundler exec trainer --path ./derived_data/Logs/Test'
        }
    }

    stage("Collect results") {
        junit 'derived_data/Logs/Test/*.xml'
    }

    stage("CLeanup") {
        sh 'git clean -dfx derived_data/Logs'
    }
}
