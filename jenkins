node {
    stage("Clone") {
        checkout scm
    }

    stage("Build") {
        sh 'swift build'
        sh 'swift package generate-xcodeproj'

        sh "xcodebuild build-for-testing -scheme 'Commands-Package' -configuration 'Debug' -derivedDataPath './derived_data'"
    }

    stage("Test") {
        sh "xcodebuild test-without-building -scheme 'Commands-Package' -configuration 'Debug' -derivedDataPath './derived_data'"
    }

    stage("Collect results") {
        sh 'pwd'
        sh '/usr/local/bin/bundler install --path vendor/bundle'
        sh '/usr/local/bin/bundler exec trainer --path ./derived_data/Logs/Test/'
    }
}